<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Health Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            min-height: 100vh;
            box-shadow: 0 0 60px rgba(0,0,0,0.15);
            border-radius: 0;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header .subtitle {
            font-size: 1rem;
            opacity: 0.95;
            position: relative;
            z-index: 2;
            font-weight: 500;
        }

        .patient-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            position: relative;
            z-index: 2;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .patient-info h2 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .patient-info p {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 400;
        }

        .health-status {
            padding: 25px 20px 20px;
            background: transparent;
        }

        .status-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            color: white;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(67, 233, 123, 0.3);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
            transform: translateY(0);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .status-card:hover::before {
            transform: scale(1);
        }

        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 60px rgba(67, 233, 123, 0.4);
        }

        .status-card.moderate {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
            box-shadow: 0 10px 40px rgba(255, 107, 107, 0.35);
        }

        .status-card.moderate:hover {
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.45);
        }

        .status-card.high {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 10px 40px rgba(238, 90, 82, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-card.high:hover {
            box-shadow: 0 20px 60px rgba(238, 90, 82, 0.5);
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1) translateY(0);
                box-shadow: 0 10px 40px rgba(238, 90, 82, 0.4);
            }
            50% { 
                transform: scale(1.02) translateY(-2px);
                box-shadow: 0 15px 50px rgba(238, 90, 82, 0.5);
            }
        }

        .status-card h3 {
            font-size: 1.3rem;
            margin-bottom: 12px;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        .risk-score {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 15px 0;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 25px;
            padding: 0 5px;
        }

        .metric-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 20px 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transition: left 0.6s ease;
        }

        .metric-card:hover::before {
            left: 100%;
        }

        .metric-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0,0,0,0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .metric-card.warning {
            border-color: rgba(255, 152, 0, 0.4);
            background: rgba(255, 243, 224, 0.95);
            box-shadow: 0 8px 32px rgba(255, 152, 0, 0.15);
        }

        .metric-card.warning:hover {
            box-shadow: 0 20px 60px rgba(255, 152, 0, 0.25);
        }

        .metric-card.danger {
            border-color: rgba(244, 67, 54, 0.4);
            background: rgba(255, 235, 238, 0.95);
            box-shadow: 0 8px 32px rgba(244, 67, 54, 0.15);
        }

        .metric-card.danger:hover {
            box-shadow: 0 20px 60px rgba(244, 67, 54, 0.25);
        }

        .metric-chart {
            height: 70px !important;
            width: 100% !important;
            margin: 12px 0 8px;
            max-height: 70px;
            border-radius: 8px;
            overflow: hidden;
        }

        .chart-container {
            height: 70px;
            width: 100%;
            overflow: hidden;
            position: relative;
            margin: 12px 0 8px;
            border-radius: 8px;
            background: rgba(102, 126, 234, 0.03);
        }

        .medication-section, .symptom-section, .vitals-trend {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .medication-section:hover, .symptom-section:hover, .vitals-trend:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.12);
        }

        .medication-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .medication-item {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            padding: 18px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .medication-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.5), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .medication-item:hover::before {
            transform: translateX(100%);
        }

        .medication-item:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .medication-item.taken {
            border-left-color: #4caf50;
            opacity: 0.7;
        }

        .medication-item.missed {
            border-left-color: #f44336;
        }

        .medication-info {
            flex: 1;
        }

        .medication-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .medication-dosage {
            font-size: 0.9rem;
            color: #666;
        }

        .medication-time {
            font-size: 0.8rem;
            color: #888;
        }

        .medication-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.taken {
            background: #e8f5e8;
            color: #4caf50;
        }

        .status-badge.pending {
            background: #fff3e0;
            color: #ff9800;
        }

        .status-badge.missed {
            background: #ffebee;
            color: #f44336;
        }

        .take-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .take-btn:hover {
            background: #5a67d8;
        }

        .take-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .symptom-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .symptom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .symptom-btn {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(224, 224, 224, 0.5);
            border-radius: 16px;
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .symptom-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            transition: all 0.4s ease;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .symptom-btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .symptom-btn:hover {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(247, 249, 255, 0.98);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
        }

        .symptom-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.3);
        }

        .symptom-btn.active::before {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
        }

        .symptom-btn i {
            display: block;
            font-size: 1.4rem;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            transition: transform 0.3s ease;
        }

        .symptom-btn:hover i {
            transform: scale(1.1);
        }

        .vitals-trend {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .trend-chart {
            height: 200px;
            margin-top: 15px;
        }

        .metric-icon {
            font-size: 1.8rem;
            margin-bottom: 12px;
            color: #667eea;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .metric-card:hover .metric-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .metric-card.warning .metric-icon {
            color: #ff9800;
        }

        .metric-card.danger .metric-icon {
            color: #f44336;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 6px;
            position: relative;
            z-index: 2;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        .section {
            padding: 0 20px 25px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, #667eea, transparent);
            border-radius: 1px;
        }

        .section-title i {
            font-size: 1.1rem;
            color: #667eea;
            padding: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }

        .updates-list {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .update-item {
            padding: 20px;
            border-bottom: 1px solid rgba(233, 236, 239, 0.5);
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            margin-bottom: 2px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .update-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.05), transparent);
            transition: left 0.5s ease;
        }

        .update-item:hover::before {
            left: 100%;
        }

        .update-item:hover {
            background: rgba(255,255,255,0.95);
            transform: translateX(4px);
        }

        .update-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .update-item.urgent {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }

        .update-item.critical {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        .update-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 5px;
        }

        .update-type {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }

        .update-time {
            font-size: 0.8rem;
            color: #666;
            margin-left: auto;
        }

        .update-message {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 18px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.4);
        }

        .action-btn:active {
            transform: translateY(-2px) scale(1.01);
        }

        .action-btn i {
            margin-right: 8px;
            font-size: 1rem;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 0.8rem;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(10px);
        }

        .trend-up {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .trend-down {
            color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .trend-stable {
            color: #666;
            background: rgba(102, 102, 102, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.2;
            color: #667eea;
        }

        .empty-state p {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.7;
        }

        .back-nav {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
        }
        
        .back-nav-btn {
            background: rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .back-nav-btn:hover {
            background: rgba(0, 0, 0, 0.25);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- Back Navigation Button -->
    <div class="back-nav">
        <button class="back-nav-btn" onclick="window.location.href = '/'" title="Back to Healthcare Dashboard">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>My Health Dashboard</h1>
            <p class="subtitle">Your health, simplified</p>
            <div class="patient-info" id="patientInfo">
                <h2>Welcome back!</h2>
                <p>Loading your health information...</p>
            </div>
        </div>

        <div class="health-status">
            <div class="status-card" id="statusCard">
                <h3>Health Status</h3>
                <div class="risk-score" id="riskScore">--</div>
                <p id="statusMessage">Checking your health...</p>
            </div>

            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-heartbeat"></i></div>
                    <div class="metric-value" id="heartRate">--</div>
                    <div class="metric-label">Heart Rate</div>
                    <div class="chart-container">
                        <canvas class="metric-chart" id="heartRateChart"></canvas>
                    </div>
                    <div class="trend-indicator trend-stable" id="hrTrend">
                        <i class="fas fa-minus"></i> Stable
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-walking"></i></div>
                    <div class="metric-value" id="steps">--</div>
                    <div class="metric-label">Steps Today</div>
                    <div class="chart-container">
                        <canvas class="metric-chart" id="stepsChart"></canvas>
                    </div>
                    <div class="trend-indicator trend-stable" id="stepsTrend">
                        <i class="fas fa-minus"></i> On track
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-bed"></i></div>
                    <div class="metric-value" id="sleep">--</div>
                    <div class="metric-label">Sleep Hours</div>
                    <div class="chart-container">
                        <canvas class="metric-chart" id="sleepChart"></canvas>
                    </div>
                    <div class="trend-indicator trend-stable" id="sleepTrend">
                        <i class="fas fa-minus"></i> Good
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon"><i class="fas fa-lungs"></i></div>
                    <div class="metric-value" id="oxygen">--</div>
                    <div class="metric-label">Blood Oxygen</div>
                    <div class="chart-container">
                        <canvas class="metric-chart" id="oxygenChart"></canvas>
                    </div>
                    <div class="trend-indicator trend-stable" id="oxygenTrend">
                        <i class="fas fa-minus"></i> Normal
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-pills"></i>
                Medications
            </h2>
            <div class="medication-section">
                <div class="medication-grid" id="medicationList">
                    <!-- Medications will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-thermometer-half"></i>
                How are you feeling?
            </h2>
            <div class="symptom-section">
                <div class="symptom-grid" id="symptomGrid">
                    <div class="symptom-btn" data-symptom="pain">
                        <i class="fas fa-exclamation-triangle"></i>
                        Pain
                    </div>
                    <div class="symptom-btn" data-symptom="fatigue">
                        <i class="fas fa-tired"></i>
                        Fatigue
                    </div>
                    <div class="symptom-btn" data-symptom="nausea">
                        <i class="fas fa-dizzy"></i>
                        Nausea
                    </div>
                    <div class="symptom-btn" data-symptom="shortness">
                        <i class="fas fa-lungs"></i>
                        Short of Breath
                    </div>
                    <div class="symptom-btn" data-symptom="headache">
                        <i class="fas fa-head-side-brain"></i>
                        Headache
                    </div>
                    <div class="symptom-btn" data-symptom="good">
                        <i class="fas fa-smile"></i>
                        Feeling Good
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-bell"></i>
                Health Updates
            </h2>
            <div class="updates-list" id="updatesList">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <p>No new updates</p>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="quick-actions">
                <button class="action-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="action-btn" onclick="contactNurse()">
                    <i class="fas fa-phone"></i> Contact Nurse
                </button>
                <button class="action-btn" onclick="startVideoCall()">
                    <i class="fas fa-video"></i> Video Call
                </button>
                <button class="action-btn" onclick="viewReports()">
                    <i class="fas fa-file-medical"></i> Reports
                </button>
            </div>
        </div>
    </div>

    <script>
        let patientData = null;
        let patientId = getPatientIdFromUrl() || '1';
        let charts = {};
        let medications = [
            { name: 'Lisinopril', dosage: '10mg', time: '8:00 AM', status: 'pending', id: 1 },
            { name: 'Metformin', dosage: '500mg', time: '12:00 PM', status: 'taken', id: 2 },
            { name: 'Atorvastatin', dosage: '20mg', time: '8:00 PM', status: 'pending', id: 3 }
        ];
        let selectedSymptoms = [];

        function getPatientIdFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/patient\/(.+)/);
            return match ? match[1] : null;
        }

        async function loadPatientData() {
            try {
                let response, data;
                
                if (patientId && patientId !== '1') {
                    // Load specific patient data
                    response = await fetch(`/api/patient/${patientId}`);
                    if (response.ok) {
                        data = await response.json();
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        // Convert single patient data to array format for compatibility
                        const patientRows = [data];
                        const latest = patientRows[0];
                        const previous = latest; // For single record, use same as previous
                        
                        patientData = { latest, previous, history: patientRows };
                        updateUI();
                        return;
                    }
                }
                
                // Fallback to all patient data if specific patient not found
                response = await fetch('/api/patient-data');
                data = await response.json();
                
                // Get patient's data (latest reading)
                const patientRows = data.filter(row => row.id === patientId);
                if (patientRows.length === 0) {
                    // If no specific patient found, use first patient
                    const firstPatient = data[0];
                    if (firstPatient) {
                        patientId = firstPatient.id;
                        const firstPatientRows = data.filter(row => row.id === patientId);
                        firstPatientRows.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        const latest = firstPatientRows[0];
                        const previous = firstPatientRows[1] || latest;
                        patientData = { latest, previous, history: firstPatientRows };
                    }
                } else {
                    patientRows.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latest = patientRows[0];
                    const previous = patientRows[1] || latest;
                    patientData = { latest, previous, history: patientRows };
                }
                
                updateUI();
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('patientInfo').innerHTML = `
                    <h2>Error Loading Patient Data</h2>
                    <p>Unable to load data for patient ID: ${patientId}</p>
                `;
            }
        }

        function updateUI() {
            if (!patientData) return;
            
            const { latest, previous } = patientData;
            
            // Update patient info
            document.getElementById('patientInfo').innerHTML = `
                <h2>Hello, ${latest.name}</h2>
                <p>Age ${latest.age} • ${latest.diagnosis}</p>
            `;
            
            // Update health status
            updateHealthStatus(latest);
            
            // Update metrics
            updateMetrics(latest, previous);
            
            // Update health messages
            updateHealthUpdates(latest);
            
            // Update medications
            updateMedications();
            
            // Update symptom tracking
            updateSymptomTracking();
            
            // Create mini charts
            createMiniCharts();
        }

        function updateHealthStatus(data) {
            const statusCard = document.getElementById('statusCard');
            const riskScore = document.getElementById('riskScore');
            const statusMessage = document.getElementById('statusMessage');
            
            riskScore.textContent = `${data.risk_score}/15`;
            
            // Update card styling based on risk
            statusCard.className = 'status-card';
            if (data.risk_category === 'High') {
                statusCard.classList.add('high');
                statusMessage.textContent = 'Please contact your healthcare provider';
            } else if (data.risk_category === 'Moderate') {
                statusCard.classList.add('moderate');
                statusMessage.textContent = 'Monitor your health closely';
            } else {
                statusMessage.textContent = 'You\'re doing great!';
            }
        }

        function updateMetrics(latest, previous) {
            // Heart Rate
            updateMetric('heartRate', `${latest.heart_rate} bpm`, 'hrTrend', 
                latest.heart_rate, previous.heart_rate, 60, 100);
            
            // Steps
            updateMetric('steps', latest.steps, 'stepsTrend', 
                latest.steps, previous.steps, 7000, null, 'steps');
            
            // Sleep
            const sleepHours = latest.sleep_hours > 0 ? `${latest.sleep_hours}h` : 'Awake';
            updateMetric('sleep', sleepHours, 'sleepTrend', 
                latest.sleep_hours, previous.sleep_hours, 7, null, 'sleep');
            
            // Oxygen
            updateMetric('oxygen', `${latest.blood_oxygen}%`, 'oxygenTrend', 
                latest.blood_oxygen, previous.blood_oxygen, 95, null);
        }

        function updateMetric(valueId, displayValue, trendId, current, previous, warningThreshold, dangerThreshold, type = '') {
            document.getElementById(valueId).textContent = displayValue;
            
            const metricCard = document.getElementById(valueId).closest('.metric-card');
            const trendElement = document.getElementById(trendId);
            
            // Clear existing classes
            metricCard.classList.remove('warning', 'danger');
            
            // Add warning/danger classes
            if (dangerThreshold && (current >= dangerThreshold || current <= (dangerThreshold - 40))) {
                metricCard.classList.add('danger');
            } else if (warningThreshold) {
                if (type === 'steps' && current < warningThreshold) {
                    metricCard.classList.add('warning');
                } else if (type === 'sleep' && current < warningThreshold && current > 0) {
                    metricCard.classList.add('warning');
                } else if (type === '' && (current < warningThreshold || current >= 100)) {
                    metricCard.classList.add('warning');
                }
            }
            
            // Update trend
            const diff = current - previous;
            if (Math.abs(diff) < 0.1) {
                trendElement.innerHTML = '<i class="fas fa-minus"></i> Stable';
                trendElement.className = 'trend-indicator trend-stable';
            } else if (diff > 0) {
                trendElement.innerHTML = `<i class="fas fa-arrow-up"></i> +${diff.toFixed(1)}`;
                trendElement.className = 'trend-indicator trend-up';
            } else {
                trendElement.innerHTML = `<i class="fas fa-arrow-down"></i> ${diff.toFixed(1)}`;
                trendElement.className = 'trend-indicator trend-down';
            }
        }

        function updateHealthUpdates(data) {
            const updatesList = document.getElementById('updatesList');
            const updates = generateHealthUpdates(data);
            
            if (updates.length === 0) {
                updatesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No new updates</p>
                    </div>
                `;
                return;
            }
            
            updatesList.innerHTML = updates.map(update => `
                <div class="update-item ${update.type}">
                    <div class="update-header">
                        <span class="update-type">${update.title}</span>
                        <span class="update-time">${update.time}</span>
                    </div>
                    <div class="update-message">${update.message}</div>
                </div>
            `).join('');
        }

        function generateHealthUpdates(data) {
            const updates = [];
            const now = new Date();
            
            // Generate automatic updates based on health data
            if (data.risk_category === 'High') {
                updates.push({
                    type: 'critical',
                    title: 'Health Alert',
                    message: 'Your risk score is elevated. Please contact your healthcare provider immediately.',
                    time: '5 min ago'
                });
            }
            
            if (data.heart_rate > 100) {
                updates.push({
                    type: 'urgent',
                    title: 'Heart Rate Alert',
                    message: 'Your heart rate is elevated. Consider resting and staying hydrated.',
                    time: '10 min ago'
                });
            }
            
            if (data.blood_oxygen < 95) {
                updates.push({
                    type: 'urgent',
                    title: 'Oxygen Level',
                    message: 'Your blood oxygen is below normal. Monitor closely and contact your nurse if it persists.',
                    time: '15 min ago'
                });
            }
            
            // Add some sample nurse messages
            updates.push({
                type: '',
                title: 'Nurse Message',
                message: 'Great job on your daily steps! Keep up the good work with your exercise routine.',
                time: '2 hours ago'
            });
            
            if (data.sleep_hours < 7 && data.sleep_hours > 0) {
                updates.push({
                    type: '',
                    title: 'Sleep Reminder',
                    message: 'Try to get 7-8 hours of sleep tonight for better recovery.',
                    time: '1 day ago'
                });
            }
            
            return updates;
        }

        function refreshData() {
            const btn = event.target.closest('.action-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            btn.disabled = true;
            
            setTimeout(() => {
                loadPatientData();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1000);
        }

        function contactNurse() {
            alert('Connecting you to your nurse...\n\nIn a real app, this would open a chat or call interface.');
        }

        function updateMedications() {
            const medicationList = document.getElementById('medicationList');
            medicationList.innerHTML = medications.map(med => `
                <div class="medication-item ${med.status}">
                    <div class="medication-info">
                        <div class="medication-name">${med.name}</div>
                        <div class="medication-dosage">${med.dosage}</div>
                        <div class="medication-time">${med.time}</div>
                    </div>
                    <div class="medication-status">
                        <span class="status-badge ${med.status}">
                            ${med.status.charAt(0).toUpperCase() + med.status.slice(1)}
                        </span>
                        ${med.status === 'pending' ? 
                            `<button class="take-btn" onclick="takeMedication(${med.id})">Take</button>` : 
                            ''}
                    </div>
                </div>
            `).join('');
        }

        function takeMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (med) {
                med.status = 'taken';
                updateMedications();
                
                // Show confirmation
                const updates = document.getElementById('updatesList');
                const newUpdate = document.createElement('div');
                newUpdate.className = 'update-item';
                newUpdate.innerHTML = `
                    <div class="update-header">
                        <span class="update-type">Medication Taken</span>
                        <span class="update-time">Just now</span>
                    </div>
                    <div class="update-message">You've taken ${med.name} ${med.dosage}</div>
                `;
                updates.insertBefore(newUpdate, updates.firstChild);
            }
        }

        function updateSymptomTracking() {
            const symptomButtons = document.querySelectorAll('.symptom-btn');
            symptomButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const symptom = btn.dataset.symptom;
                    btn.classList.toggle('active');
                    
                    if (selectedSymptoms.includes(symptom)) {
                        selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
                    } else {
                        selectedSymptoms.push(symptom);
                    }
                    
                    // Log symptom
                    if (selectedSymptoms.length > 0) {
                        console.log('Symptoms logged:', selectedSymptoms);
                    }
                });
            });
        }

        function createMiniCharts() {
            // Generate some sample historical data
            const history = generateSampleHistory();
            
            // Heart Rate Chart
            createChart('heartRateChart', history.heartRate, '#ff6384');
            
            // Steps Chart
            createChart('stepsChart', history.steps, '#4bc0c0');
            
            // Sleep Chart
            createChart('sleepChart', history.sleep, '#ffce56');
            
            // Oxygen Chart
            createChart('oxygenChart', history.oxygen, '#36a2eb');
        }

        function generateSampleHistory() {
            const days = 7;
            const history = {
                heartRate: [],
                steps: [],
                sleep: [],
                oxygen: []
            };
            
            for (let i = days; i >= 0; i--) {
                history.heartRate.push(65 + Math.random() * 20);
                history.steps.push(7000 + Math.random() * 5000);
                history.sleep.push(6 + Math.random() * 3);
                history.oxygen.push(96 + Math.random() * 3);
            }
            
            return history;
        }

        function createChart(canvasId, data, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            // Set canvas dimensions explicitly
            canvas.style.height = '70px';
            canvas.style.width = '100%';
            canvas.height = 70;
            canvas.width = canvas.offsetWidth;
            
            const ctx = canvas.getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['7d', '6d', '5d', '4d', '3d', '2d', '1d', 'Now'],
                    datasets: [{
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '15',
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBorderWidth: 2,
                        pointHoverBackgroundColor: color,
                        pointHoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: color,
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        line: { borderWidth: 2.5 }
                    },
                    layout: {
                        padding: 0
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function startVideoCall() {
            alert('Starting video call with your healthcare provider...\n\nIn a real app, this would launch a video call interface.');
        }

        function viewReports() {
            alert('Opening your health reports...\n\nIn a real app, this would show detailed medical reports and test results.');
        }

        // Load data when page loads
        loadPatientData();
        
        // Refresh data every 30 seconds
        setInterval(loadPatientData, 30000);
    </script>
</body>
</html>
